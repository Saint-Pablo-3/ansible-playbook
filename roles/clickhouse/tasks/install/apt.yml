---
# Install ClickHouse for Debian/Ubuntu

- name: Ensure dependencies for repo
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
    state: present
    update_cache: true
  become: true
  tags: [install]

- name: Download ClickHouse GPG key (new official URL)
  ansible.builtin.command:
    cmd: >
      curl -fsSL https://packages.clickhouse.com/rpm/lts/repodata/repomd.xml.key
      | gpg --dearmor -o /usr/share/keyrings/clickhouse-keyring.gpg
  args:
    creates: /usr/share/keyrings/clickhouse-keyring.gpg
  become: true
  tags: [install]

- name: Add ClickHouse APT repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/clickhouse-keyring.gpg] https://packages.clickhouse.com/deb stable main"
    state: present
  become: true
  tags: [install]

- name: Update apt cache
  apt:
    update_cache: true
  become: true
  tags: [install]

- name: Install ClickHouse packages
  apt:
    name:
      - clickhouse-server
      - clickhouse-client
    state: present
  become: true
  tags: [install]

